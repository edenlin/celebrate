<!DOCTYPE html>
<head></head>
<body>
<style>
.base
{
	background: #AAA;
	border-color: #666;
}
#beats div
{
	position: absolute;
}
#rules div
{
	position: absolute;
	width: 100%;
	height: 1px;
	border-top: 1px solid #BBB;
}
#bars div
{
	position: absolute;
	width: 300px;
	height: 100%;
	background: #EFEFEF;
}
#chart
{
	border: 1px solid black;
	position: absolute;
	top: 50px;
	overflow: hidden;
}
#hitmessage div
{
	font-family: Arial, sans;
	font-size: 30px;
}
.red
{
	color: #F22;
	text-shadow: 0px 0px 10px #FFA800;
}
.green
{
	color: #007432;
	text-shadow: 0px 0px 10px #AAA;
}
</style>

<div id='hitmessage'>
	<!--
	<div class='red'><span style='font-size:120%;'>Perfec</span>池!</div>
	<div class='red'>Good</div>
	<div class='green'>bad</div>
	<div class='green'>miss</div>
	-->
</div>

<div id='chart'>
	<!--
	<div id='rules'>
		<div></div>
	</div>
	<div id='bars'>
	</div>
	<div id='beats'>
	</div>
	<div id='marks'>
	</div>
	<div id='hitmarks'>
	</div>
	-->
</div>

<script src="../third_party/require.js"></script>
<script>
requirejs.config({
	baseUrl: '../../',
	paths: {
		'cele':'celebrate/src',
		'third_party':'celebrate/third_party'
	}
});
requirejs(['cele/gamedata','cele/chart'],
function(gamedata,Chart){

var chart_config=
{
	div: $('chart'),	//chart element
	width: 1000,		//width in px
	timescale: 300,		//length in pixels representing one second
	resolution: 45,		//processing framerate
	block: { w:50, h:50}, //size of a block
	lineheight: 70,		//line height
	lines: 4,			//number of lines
	basebeat: 2,		//interval of basebeat in seconds, visualized by bars
	data: gamedata,		//data object exported by `editor`
	ondata: classify,	//return the y position and sprite frame of a beat
	beat:		//animator and sprite config for a beat
	{
		x:0, y:0,     //top left margin of the frames
		w:52, h:50,   //width, height of a frame
		gx:10,gy:1,   //define a gx*gy grid of frames
		img:'beats.png', //image
		centerx: 50/2, centery: 50/2, //center point to check for coincidence
		dist: 30 //if(dist<30) when hit, change to `hitframe`
	},
	mark:		//mark at the left most of each line
	{
		x:0, y:50,
		w:70, h:70,
		gx:10, gy:1,
		img:'beats.png',
		line:[ //sprite frame index at each line
		1,
		0,
		1,
		0],
		centerx: 70/2, centery: 70/2
	},
	hitmark:	//mark when a proper beat is being hit
	{
		x:0, y:0,
		w:400, h:180,
		gx:10, gy:1,
		img:'mark.png',
		centerx: 180/2, centery: 180/2,
		dist: 30, //if(dist<30) when hit, show the hitmark
		frame: 0,
		showtime: 0.08
	},
	hitmessage:
	{
		div: $('hitmessage'),
		showtime: 0.2,
		list:
		[	//must be sorted to ascending order of dist
			//	i.e. distance between center points of `beat` and `mark`
			{
				dist: 15, //if(d<=15)
				html: "<div class='red'><span style='font-size:110%;'>Perfec</span>池!</div>"
			},
			{
				dist: 30, //else if(d<=30)
				html: "<div class='red'>Good</div>"
			},
			{
				dist: 45, //else if(d<=45)
				html: "<div class='green'>bad</div>"
			},
			{
				dist: null, //else
				html: "<div class='green'>miss</div>"
			}
		]
	}
}

function classify(v)
{
	var res=
	{
		y: 0,
		frame: 0,
		hit_frame: 0
	}
	switch(v)
	{
		case 'd3': case 'd4': case 'd5': case 'd6': case 'd7': 
		case 'df': case 'dv': 
		res.frame = 2;
		res.hitframe = 3;
		break;

		case 'dr': case 'dt': case 'dy': case 'du':
		case 'db': case 'dg': case 'dn':
		res.frame = 0;
		res.hitframe = 1;
		break;
	}
	var padding = (chart_config.lineheight - chart_config.block.h)/2;
	switch(v)
	{
		case 'd3': case 'd4': case 'd5': case 'd6': case 'd7': 
			res.y = 0;
		break;
		case 'dr': case 'dt': case 'dy': case 'du':
			res.y = chart_config.lineheight + padding;
		break;
		case 'df': case 'dg':
			res.y = chart_config.lineheight * 2 + padding;
		break;
		case 'dv': case 'db': case 'dn':
			res.y = chart_config.lineheight * 3 + padding;
		break;
	}

	return res;
}

var chart = new Chart(chart_config);
chart.test_run();//0.02

document.addEventListener("keydown", keydown, true);
function keydown(e)
{
	if (!e) e = window.event;
	var a = e.keyCode;
	if (a>='0'.charCodeAt(0) && a<='9'.charCodeAt(0))
	{
		chart.hit(0);
		return true;
	}
	else
	{
		switch (String.fromCharCode(a).toLowerCase())
		{
		case 'q': case 'w': case 'e': case 'r': case 't': case 'y':
		 case 'u': case 'i': case 'o': case 'p':
			chart.hit(1);
			return true;
		
		case 'a': case 's': case 'd': case 'f': case 'g':
		 case 'h': case 'j': case 'k': case 'l':
			chart.hit(2);
			return true;
		
		case 'z': case 'x': case 'c': case 'v':
		 case 'b': case 'n': case 'm':
			chart.hit(3);
			return true;
		}
	}
}

//helpers
function $(id)
{
	return document.getElementById(id);
}

});
</script>
</body>
