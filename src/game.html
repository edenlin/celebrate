<body>
<style>
.brass
{
background: #fbe6c5;
background: -moz-linear-gradient(-45deg,  #fbe6c5 0%, #e8ae52 26%, #e3a033 32%, #f7dbad 100%);
background: -webkit-gradient(linear, left top, right bottom, color-stop(0%,#fbe6c5), color-stop(26%,#e8ae52), color-stop(32%,#e3a033), color-stop(100%,#f7dbad));
background: -webkit-linear-gradient(-45deg,  #fbe6c5 0%,#e8ae52 26%,#e3a033 32%,#f7dbad 100%);
background: -o-linear-gradient(-45deg,  #fbe6c5 0%,#e8ae52 26%,#e3a033 32%,#f7dbad 100%);
background: -ms-linear-gradient(-45deg,  #fbe6c5 0%,#e8ae52 26%,#e3a033 32%,#f7dbad 100%);
background: linear-gradient(135deg,  #fbe6c5 0%,#e8ae52 26%,#e3a033 32%,#f7dbad 100%);
filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#fbe6c5', endColorstr='#f7dbad',GradientType=1 );
border-color: #815C23;
text-shadow: 2px 2px 0px #815C23,
			 2px -2px 0px #815C23,
			-2px 2px 0px #815C23,
			-2px -2px 0px #815C23,
			0px 0px 0px #F00
			;
}
.drum
{
background: #ca877a;
background: -moz-linear-gradient(45deg,  #ca877a 0%, #954f41 68%, #a95949 74%, #d19387 100%);
background: -webkit-gradient(linear, left bottom, right top, color-stop(0%,#ca877a), color-stop(68%,#954f41), color-stop(74%,#a95949), color-stop(100%,#d19387));
background: -webkit-linear-gradient(45deg,  #ca877a 0%,#954f41 68%,#a95949 74%,#d19387 100%);
background: -o-linear-gradient(45deg,  #ca877a 0%,#954f41 68%,#a95949 74%,#d19387 100%);
background: -ms-linear-gradient(45deg,  #ca877a 0%,#954f41 68%,#a95949 74%,#d19387 100%);
background: linear-gradient(45deg,  #ca877a 0%,#954f41 68%,#a95949 74%,#d19387 100%);
filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ca877a', endColorstr='#d19387',GradientType=1 );
border-color: #7B3122;
text-shadow: 1px 1px 0px #7B3122,
			 1px -1px 0px #7B3122,
			-1px 1px 0px #7B3122,
			-1px -1px 0px #7B3122,
			0px 0px 0px #F00
			;
}
.base
{
	background: #AAA;
	border-color: #666;
}
#beats div
{
	position: absolute;
	width:48px;
	height:48px;
    line-height:50px;
	border-radius:8px;
    text-align: center;
	border-width: 2px;
	border-style: solid;
	/*text*/
	font-size: 25px;
	font-family: jhenghei, sans;
	font-weight: bold;
	color: white;
}
#rules div
{
	position: absolute;
	width: 100%;
	height: 1px;
	border-top: 1px solid #BBB;
}
#bars div
{
	position: absolute;
	width: 300px;
	height: 100%;
	background: #EFEFEF;
}
#chart
{
	border: 1px solid black;
	position: relative;
	overflow: hidden;
}
.big
{
	font-family: Arial, sans;
	font-size: 30px;
}
.red
{
	color: #F22;
	text-shadow: 0px 0px 10px #FFA800;
}
.green
{
	color: #007432;
	text-shadow: 0px 0px 10px #AAA;
}
</style>

<div id='chart'>
	<!--
	<div id='rules'>
		<div></div>
	</div>
	<div id='bars'>
	</div>
	<div id='beats'>
	</div>
	-->
</div>

<!--
<div class='brass'><span>5</span></div>
<div class='drum'><span>r</span></div>
<div class='brass'><span>f</span></div>
<div class='drum'><span>b</span></div>
<div class='base'></div>
<div class='big red'>Good</div>
<div class='big red'>Perfec<span style='font-size:90%;'>æ± </span></div>
<div class='big green'>bad</div>
<div class='big green'>miss</div>
-->

<script src="../third_party/require.js"></script>
<script>
requirejs.config({
	baseUrl: '../../',
	paths: {
		'cele':'celebrate/src',
		'third_party':'celebrate/third_party'
	}
});
requirejs(['F.core/effects-pool','cele/gamedata'],function(Fset,gamedata){

var chart_config=
{
	div: $('chart'),	//chart element
	width: 1200,		//width in px
	timescale: 300,		//length in pixels representing one second
	resolution: 45,		//processing framerate
	block: { w:50, h:50}, //size of a block
	lineheight: 70,		//line height
	lines: 4,			//number of lines
	basebeat: 2,		//interval of basebeat in seconds, visualized by bars
	data: gamedata,		//data object exported by `editor`
	ondata: classify	//return the name,class and y position of a data beat
}

function classify(v)
{
	var res=
	{
		'name': v.slice(1),
		'class': '',
		'y': 0
	}
	switch(v)
	{
		case 'd3': case 'd4': case 'd5': case 'd6': case 'd7': 
		case 'df': case 'dv': 
		res['class'] = 'brass';
		break;

		case 'dr': case 'dt': case 'dy': case 'du':
		case 'db': case 'dg': case 'dn':
		res['class'] = 'drum';
		break;
	}
	switch(v)
	{
		case 'd3': case 'd4': case 'd5': case 'd6': case 'd7': 
			res.y = 0;
		break;
		case 'dr': case 'dt': case 'dy': case 'du':
			res.y = chart_config.lineheight;
		break;
		case 'df': case 'dg':
			res.y = chart_config.lineheight * 2;
		break;
		case 'dv': case 'db': case 'dn':
			res.y = chart_config.lineheight * 3;
		break;
	}

	return res;
}

function Chart(config)
{
	var div = config.div;
	var data = config.data;
	div.style.width = config.width+'px';
	div.style.height = config.lineheight*config.lines+'px';

	//rules
	create_element('div','bars',null,null,div);
	create_element('div','rules',null,null,div);
	for( var i=1; i<config.lines; i++)
		set_xy(create_element('div',null,null,null,$('rules')), 0, i*config.lineheight);

	//bars & beats
	create_element('div','beats',null,null,div);
	var br_config=
	{
		init_size: 5,
		batch_size: 5,
		max_size: 100,
		construct: function()
		{
			return new Beat($('bars'));
		}
	}
	var bt_config=
	{
		init_size: 20,
		batch_size: 10,
		max_size: 100,
		construct: function()
		{
			return new Beat($('beats'));
		}
	}
	var bars = new Fset(br_config);
	var beats = new Fset(bt_config);

	//clock
	var begintime = new Date().getTime()/1000;
	var lasttime = 0;
	var lastbar = 0;
	var beatcursor = 0;
	var clock = setInterval(function()
	{
		var time = new Date().getTime()/1000-begintime; //time in sec
		var margin = time + config.width/config.timescale; //the right margin time

		//bars
		if( margin >= lastbar + config.basebeat)
		{
			bars.create(config.width);
			lastbar = Math.floor(margin/config.basebeat)*config.basebeat; //round down to basebeat time
		}
		//beats
		for( var j=beatcursor, beatlength=data.beats.length; j<beatlength; j++)
		{
			if( margin < data.beats[j].t)
				break;
		}
		if( j>beatcursor)
		{
			for( var k=beatcursor; k<j; k++)
			{
				var res=config.ondata(data.beats[k].v);
				beats.create(config.width, res.y, res['name'], res['class']);
			}
			beatcursor=j;
		}

		//updates
		var diff= (time-lasttime)*config.timescale;
		bars .call_each('frame', diff);
		beats.call_each('frame', diff);

		//wrap up
		lasttime = time;
	}, 1000/config.resolution);
}

function Beat(holder)
{
	this.el = create_element('div',null,null,null,holder);
	this.die();
}
Beat.prototype.born=function(x,y,Name,Class)
{
	set_xy(this.el, x, y);
	if( Name)
		this.el.innerHTML=Name;
	if( Class)
		this.el.setAttribute('class',Class);
}
Beat.prototype.die=function()
{
	set_xy(this.el, -1000);
}
Beat.prototype.frame=function(speed)
{
	move_xy(this.el, -speed);
	if( get_xy(this.el).x < -1000)
		this.parent.die();
}

var chart = new Chart(chart_config);

//helpers
function set_xy(el,x,y)
{
	if( x!==undefined && x!==null)
		el.style.left = x+'px';
	if( y!==undefined && y!==null)
		el.style.top  = y+'px';
	return el;
}
function move_xy(el,x,y)
{
	if( x)
		el.style.left = x+parseInt(el.style.left)+'px';
	if( y)
		el.style.top  = y+parseInt(el.style.top)+'px';
	return el;
}
function get_xy(el)
{
	return {
		x: parseInt(el.style.left),
		y: parseInt(el.style.top)
	}
}
function create_element(tag,id,Class,innerHTML,appendto)
{
	var el = document.createElement(tag);
	if( id)
		el.id=id;
	if( Class)
		el.setAttribute('class',Class);
	if( innerHTML)
		el.innerHTML= innerHTML;
	if( appendto)
		appendto.appendChild(el);
	return el;
}
function $(id)
{
	return document.getElementById(id);
}

});
</script>
</body>
