<head>
<meta http-equiv='content-type' content='text/html; charset=UTF-8'>
<script src='../third_party/head.load.min.js'></script>
<style>
.bar
{
	position: absolute;
	border-left: 1px solid #66F;
	width: 0px;
}
.anchor
{
	position: absolute;
	width: 5px;
	height: 40px;
	cursor: w-resize;
}
.lyrics
{
	width: auto;
	color: #FFF;
	background-color: #668;
	font-size: 20px;
	white-space: nowrap;
}
#wave
{
	-webkit-user-select: none;
	-khtml-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}
#wave
{
	position: absolute;
	left: 0px;
	top: 0px;
	width: 99%;
	height: 410px;
	overflow-x: scroll;
	overflow-y: hidden;
}
#seeker
{
	position: absolute;
	left: 0px;
	top: 0px;
	width: 100%;
	height: 30px;
	background-color: #EEE;
	cursor: e-resize;
}
.timescale
{
	border-left: 1px solid #888;
	float: left;
	height: 100%;
	font-size: 12px;
}
#toolbar
{
	position: absolute;
	left: 0px;
	top: 410px;
	width: 99%;
	line-height: 30px;
}
.panel
{
	width: 49.5%;
	float: left;
}
.dialog
{
	border: 1px solid #AAA;
	width: 100%;
	float: left;
}
.tool
{
	float: left;
	height: 28px;
}
#timer
{
	width: 80px;
	height: 25px;
	border: 1px solid #AAA;
}
#ly-box
{
	width: 200px;
}
#texter
{
	float: left;
	width: 100%;
	height: 260px;
}
#drumset
{
	height: 260px;
}
#drumset-dialog
{
	position: relative;
}
</style>
</head>

<body>

<div id='wave'>
	<div id='seeker'></div>
	<div id='bt-holder'></div>
	<div id='ly-holder'></div>
	<div id='waveform'></div>
</div>

<div id='toolbar'>

	<div class='panel'>
		<div class='dialog'>
			<button id='pause' class='tool'></button>
			<div id='timer' class='tool'>nan</div>
		</div>

		<br>
		<div class='dialog' id='drumset-dialog'>
			Drumset
			<div id='drumset'>
				<div id='dr' key='r' sound='AMB_HTM' radius='35' img='drum.png'><br>&nbsp;&nbsp;&nbsp;r</div>
				<div id='dt' key='t' sound='AMB_MTM' radius='40' img='drum.png'><br>&nbsp;&nbsp;&nbsp;t</div>
				<div id='dy' key='y' sound='AMB_FTM2' radius='40' img='drum.png'><br>&nbsp;&nbsp;&nbsp;y</div>
				<div id='du' key='u' sound='AMB_LTM2' radius='55' img='drum.png'>&nbsp;u</div>

				<div id='d3' key='3' sound='CRASH_5' radius='45' img='crash.png' vol='70'>3</div>
				<div id='d4' key='4' sound='CRASH_1' radius='40' img='crash.png' vol='45'>4</div>
				<div id='d5' key='5' sound='CRASH_6' radius='50' img='crash.png'>5</div>
				<div id='d6' key='6' sound='AMB_HHPD' radius='35' img='crash2.png' vol='70'>6</div>
				<div id='d7' key='7' sound='CHINA_1' radius='40' img='crash2.png' vol='70'>7</div>

				<div id='df' key='f' sound='AMB_HHCL' radius='43' img='crash2.png' vol='70'>f</div>
				<div id='dv' key='v' sound='AMB_HHOP' radius='20' vol='70'>v</div>
				<div id='db' key='b' sound='AMB_SN13' radius='50' img='drum.png'>b</div>
				<div id='dg' key='g' sound='AMB_RIM1' radius='15'>g</div>
				<div id='dn' key='n' sound='AMB_SN_5' radius='35'>n</div>
				<style>
				#dr { left: 105px; top: 130px; }
				#dt { left: 175px; top: 100px; }
				#dy { left: 270px; top: 100px; }
				#du { left: 350px; top: 160px; }

				#d3 { left: 50px; top: 65px; }
				#d4 { left: 140px; top: 40px; }
				#d5 { left: 240px; top: 20px; }
				#d6 { left: 340px; top: 60px; }
				#d7 { left: 380px; top: 100px; }

				#df { left: 100px; top: 190px; }
				#dv { left: 121px; top: 211px; }
				#db { left: 210px; top: 170px; }
				#dg { left: 200px; top: 200px; }
				#dn { left: 260px; top: 180px; }
				#drumset div
				{
					cursor: pointer;
					position: absolute;
					font-size: 14px;
					line-height: 22px;
					/*border: 1px solid black;*/
				}
				</style>
			</div><!--drumset-->
		</div><!--drumset dialog-->
	</div>

	<div class='panel'>
		<div class='dialog'>
			<button id='addlyrics' class='tool'>[L] add lyrics</button>
			<input id='ly-box' class='tool' value="lyrics here"/>
			<button id='delete' class='tool'>[D] delete</button>
			<br>
			<button id='openmusic' class='tool'>open music</button>
			<div id='openform'>
				<br>
				music file: <input id='openform-music' value='../music/Jubilant.mp3' /><br>
				waveform file: <input id='openform-waveform' value='../music/Jubilant-sample.js' /><br>
				HD: <input id='openform-hd' type='checkbox' />
			</div>
			<div class='tool' style='width:20px;'></div>
			data:
			<button id='import' class='tool'>import</button>
			<button id='export' class='tool'>export</button>
			<textarea id='texter' class='tool'>
			</textarea>
		</div>
	</div>

</div>


<script>
(function()
{
	//set up
	var height=410;
	var horiscale=120;
	var lasttime=0;
	var mysound;
	var dragging=null;
	var store;
	var cursor;
	var cursor_timer;

	// load waveform file
	load_waveform('../music/Jubilant-sample.js');
	function load_waveform(filepath)
	{
		head.js(filepath,function()
		{
			create_cursor();
			create_waveform();
		});
	}

	// load sound
	head.js('../third_party/require.js',function()
	{
		requirejs.config({
			baseUrl: '../../',
			paths: {
				'cele':'celebrate/src',
				'third_party':'celebrate/third_party'
			}
		});
		//
		requirejs(['cele/drum'],
		function(Drum)
		{
			var drumset = new Drum($('drumset'));
			// buzz is required by drum
			load_sound('../music/Jubilant');
		});
	});
	function load_sound(filepath)
	{
		var has_extension=false;
		if( filepath.indexOf('.mp3')!==-1 ||
		    filepath.indexOf('.ogg')!==-1 ||
		    filepath.indexOf('.wav')!==-1 )
			has_extension=true;

		mysound = new buzz.sound( filepath,
		{
			formats: has_extension ? null:['mp3','ogg'],
			preload: true,
			autoplay: false,
			loop: false
		});
		mysound
		.bind('timeupdate', function(e)
		{
			var t=this.getTime();
			//
			cursor.style.left=round(t*horiscale)+'px';
			var diff= t*horiscale - $('wave').scrollLeft;
			if( diff>900 || diff<0)
				$('wave').scrollLeft=round(t*horiscale-50);
			if( t<1)
				$('wave').scrollLeft=1;
			$('timer').innerHTML=t;
			//
			lasttime=new Date().getTime();
		})
		.bind('loadedmetadata', function()
		{
			create_timescale();
		});
	}

	// load others
	$('openform').style.display='none';
	$('openmusic').onclick=function()
	{
		if( this.innerHTML==='open music')
		{
			this.innerHTML='load';
			$('openform').style.display='';
		}
		else
		{
			this.innerHTML='open music';
			$('openform').style.display='none';
			clear_div($('seeker'));
			clear_div($('bt-holder'));
			clear_div($('ly-holder'));
			clear_div($('waveform'));
			load_sound($('openform-music').value);
			load_waveform($('openform-waveform').value);
		}
	}

	// waveform
	function create_waveform()
	{
		var step=5;
		if( $('openform-hd').checked)
			step=1;
		for( var i=0; i<data.data.length; i+=step)
		{
			value(data.data[i]);
		}
	}
	function value(sam)
	{
		var bar = document.createElement('div');
		bar.setAttribute('class','bar');
		var V= sam.v>0 ? sam.v:-sam.v;
		bar.style.height=(V*2+'px');
		bar.style.top=(height/2-V)+'px';
		bar.style.left=round(sam.t*horiscale)+'px';
		$('waveform').appendChild(bar);
		return bar;
	}

	// cursor
	function create_cursor()
	{
		cursor=value({t:0,v:height});
		cursor.style.borderLeft='2px solid #F66';
		cursor.style.top='0px';
		cursor.style.left='0px';
		cursor.style.height=height+'px';
	}
	cursor_timer = setInterval(function()
	{
		var curtime = new Date().getTime();
		if( mysound)
		if( !mysound.isPaused())
		{
			var x=parseInt(cursor.style.left);
			x += (curtime-lasttime)*horiscale/1000;
			cursor.style.left=round(x)+'px';
		}
		lasttime=curtime;
	}, 1000/20);

	// seeker controls
	$('pause').innerHTML='[p] play';
	$('pause').onclick=function()
	{
		if( this.innerHTML==='[p] pause')
		{
			mysound.pause();
			this.innerHTML='[p] play';
		}
		else
		{
			mysound.play();
			this.innerHTML='[p] pause';
		}
	}
	function create_timescale(duration)
	{
		$('seeker').style.width= mysound.getDuration() * horiscale+'px';
		for( var i=0, lim=round(mysound.getDuration(),0); i<lim; i++)
		{
			var scale= document.createElement('div');
			scale.innerHTML= i;
			scale.setAttribute('class','timescale');
			scale.style.width= (horiscale-1)+'px';
			$('seeker').appendChild(scale);
		}
		$('seeker').onmousedown=function(e)
		{
			e=e?e:event;
			var px= e.clientX + $('wave').scrollLeft;
			var tt= px / horiscale;
			mysound.setTime(tt);
			return true;
		}
	}

	// anchor tools
	$('delete').style.display='none';
	$('delete').onclick=function()
	{
		if( dragging)
		{
			dragging.parentNode.removeChild(dragging);
			dragging=null;
		}
	}
	$('addlyrics').onclick=function()
	{
		if( $('ly-box').value)
		{
			add_lyrics(
				{
					x: parseInt(cursor.style.left),
					y: 350
				},
				$('ly-box').value
			);
			$('ly-box').value='';
		}
	}
	function add_lyrics(P,mess)
	{
		var lyr= anchor(P,'ly');
		lyr.setAttribute('class','anchor lyrics');
		lyr.innerHTML= mess;
	}
	function anchor(P,type)
	{
		var anc = document.createElement('div');
		anc.setAttribute('class','anchor');
		anc.style.left= round(P.x)+'px';
		anc.style.top= round(P.y)+'px';
		anc.onmousedown=function()
		{
			this.style.border= '1px solid #AFF';
			dragging=this;
			$('delete').style.display='';
		}
		$(type+'-holder').appendChild(anc);
		return anc;
	}
	$('wave').onmousemove=function(e)
	{
		if( dragging)
		{
			e=e?e:event;
			var px= e.clientX + $('wave').scrollLeft;
			dragging.style.left= px+'px';
		}
	}
	$('wave').onmouseup=function(e)
	{
		if( dragging)
		{
			dragging.style.border='';
			dragging=null;
			$('delete').style.display='none';
		}
	}

	// keyboard controls
	document.addEventListener("keydown", keydown, true);
	function keydown(e)
	{
		if (!e) e = window.event;
		if( document.activeElement !== $('ly-box'))
		switch (keycode_to_keyname(e.keyCode))
		{
			case 'p':
				$('pause').onclick.call($('pause'));
			return true;

			case 'l':
				$('addlyrics').onclick();
			return true;

			case 'd':
				$('delete').onclick();
			return true;
		}
	}
	function keycode_to_keyname(code)
	{
		if( (code>='A'.charCodeAt(0) && code<='Z'.charCodeAt(0)) ||
			(code>='0'.charCodeAt(0) && code<='9'.charCodeAt(0)) )
		{
			return String.fromCharCode(code).toLowerCase();
		}
		return '';
	}

	// export
	$('export').onclick=function()
	{
		var struct=
		{
			lyrics:[],
			beat:[]
		};
		var content='';
		var LYR = $('ly-holder').getElementsByClassName('anchor lyrics');
		for( var i=0; i<LYR.length; i++)
		{
			var px= parseInt(LYR[i].style.left);
			var tt= round(px / horiscale);
			struct.lyrics.push({
				t: tt,
				v: LYR[i].innerHTML
			});
		}
		content=JSON.stringify(struct,null,' ');
		$('texter').value=content;
		//
		head.js('../third_party/FileSaver.js',
				'../third_party/BlobBuilder.js',
				function(){
			var bb = new BlobBuilder;
			bb.append(content);
			var blob = bb.getBlob("text/plain;charset=utf-8");
			saveAs(blob, 'out.js');
		});
	}

	// import
	$('import').onclick=function()
	{
		var struct=JSON.parse($('texter').value);
		if( struct)
		{
			clear_div($('ly-holder'));
			//
			if( struct.lyrics)
			for( var i=0; i<struct.lyrics.length; i++)
			{
				add_lyrics(
					{
						x: struct.lyrics[i].t * horiscale,
						y: 350
					},
					struct.lyrics[i].v
				);
			}
		}
	}

	// persist & default data
	head.js('../third_party/persist-min.js',function()
	{
		store = new Persist.Store('celebrate-editor');
		window.onbeforeunload = function()
		{
			store.set('data', $('texter').value);
		}
		store.get('data',
		function(ok,value){
			if(ok && value!='')
			{
				$('texter').value = value;
				$('import').onclick();
			}
			else
			{
				head.js('../music/Jubilant-default.js',function()
				{
					$('import').onclick();
				});
			}
		});
	});

	// helpers
	function round(v,d)
	{
		if(d===undefined || d===null)
			d=2;
		var exp=1;
		for( var i=0; i<d; i++)
			exp*=10;
		return Math.round(v*exp)/exp;
	}
	function $(id)
	{
		return document.getElementById(id);
	}
	function clear_div(el)
	{
		var parent = el.parentNode;
		var id=el.getAttribute('id');
		var cl=el.getAttribute('class');
		el.parentNode.removeChild(el);
		var hold = document.createElement('div');
		hold.setAttribute('id',id);
		hold.setAttribute('class',cl);
		parent.appendChild(hold);
	}

}());
</script>
</body>
